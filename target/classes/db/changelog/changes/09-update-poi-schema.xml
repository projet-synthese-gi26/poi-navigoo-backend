<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="09-update-poi-schema" author="yowpoint">
        <!-- Change location_geog to GEOGRAPHY type.
             Note: altering from GEOMETRY to GEOGRAPHY might require casting.
             If the column is empty it's easy. If not, we might need USING.
             Assuming for now we can alter it.
        -->
        <sql>
            ALTER TABLE point_of_interest
            ALTER COLUMN location_geog TYPE GEOGRAPHY(Point, 4326)
            USING location_geog::geography;
        </sql>

        <!-- Change JSONB columns to JSON -->
        <sql>
            ALTER TABLE point_of_interest
            ALTER COLUMN operation_time_plan TYPE JSON USING operation_time_plan::json,
            ALTER COLUMN poi_contacts TYPE JSON USING poi_contacts::json;
        </sql>

        <!-- Add new columns -->
        <addColumn tableName="point_of_interest">
            <column name="status" type="VARCHAR(50)">
                 <constraints nullable="false"/>
            </column>
            <column name="approuved_by_user_id" type="UUID">
                 <constraints foreignKeyName="fk_poi_approved_by" references="app_user(user_id)"/>
            </column>
        </addColumn>

        <!-- Set default for status and is_active -->
        <sql>
            ALTER TABLE point_of_interest ALTER COLUMN status SET DEFAULT 'SUBMITTED';
            UPDATE point_of_interest SET status = 'SUBMITTED' WHERE status IS NULL;
            ALTER TABLE point_of_interest ALTER COLUMN is_active SET DEFAULT FALSE;
        </sql>
        
    </changeSet>

</databaseChangeLog>
